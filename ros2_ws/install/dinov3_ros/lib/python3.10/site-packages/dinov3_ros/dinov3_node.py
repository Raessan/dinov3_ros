import cv2
from typing import List, Dict
from cv_bridge import CvBridge

import rclpy
from rclpy.qos import QoSProfile
from rclpy.qos import QoSHistoryPolicy
from rclpy.qos import QoSDurabilityPolicy
from rclpy.qos import QoSReliabilityPolicy
from rclpy.lifecycle import LifecycleNode
from rclpy.lifecycle import TransitionCallbackReturn
from rclpy.lifecycle import LifecycleState

import torch
import numpy as np

class Dinov3Node(LifecycleNode):

    def __init__(self) -> None:
        super().__init__("dinov3_node")
        self.get_logger().info(f"[{self.get_name()}] Creating...")

        # General params
        self.declare_parameter("img_size", 800)
        self.declare_parameter("patch_size", 16)
        self.declare_parameter("img_mean", [0.485, 0.456, 0.406])
        self.declare_parameter("img_std", [0.229, 0.224, 0.225])
        self.declare_parameter("device", 'cuda')
        self.declare_parameter("input_image_topic", 'image/topic')

        # DINO model params
        self.declare_parameter("dino_model.model_path", '')
        self.declare_parameter("dino_model.model_name", 'dinov3_vits16plus')
        self.declare_parameter("dino_model.n_layers", 12)
        self.declare_parameter("dino_model.embed_dim", 384)

        # Object detection model params
        self.declare_parameter("object_detection_model.model_path", '')
        self.declare_parameter("object_detection_model.fpn_ch", 192)
        self.declare_parameter("object_detection_model.n_convs", 4)

        # Modes
        self.declare_parameter("debug", False)
        self.declare_parameter("use_object_detection", False)

    def on_configure(self, state: LifecycleState) -> TransitionCallbackReturn:
        self.get_logger().info(f"[{self.get_name()}] Configuring...")

        # General params
        self.img_size = self.get_parameter("img_size").get_parameter_value().integer_value
        self.patch_size = self.get_parameter("patch_size").get_parameter_value().integer_value
        self.img_mean = self.get_parameter("img_mean").get_parameter_value().double_array_value
        self.img_std = self.get_parameter("img_std").get_parameter_value().double_array_value
        self.device = self.get_parameter("device").get_parameter_value().string_value
        self.input_image_topic = self.get_parameter("input_image_topic").get_parameter_value().string_value

        # DINO model params
        self.dino_model = {
            'model_path': self.get_parameter('dino_model.model_path').get_parameter_value().string_value,
            'model_name': self.get_parameter('dino_model.model_name').get_parameter_value().string_value,
            'n_layers': self.get_parameter('dino_model.n_layers').get_parameter_value().integer_value,
            'embed_dim': self.get_parameter('dino_model.embed_dim').get_parameter_value().integer_value,
        }

        # Modes
        self.debug = self.get_parameter("debug").get_parameter_value().bool_value
        self.use_object_detection = self.get_parameter("use_object_detection").get_parameter_value().bool_value



        print(self.debug)
        print(self.device)
        print(self.dino_model['embed_dim'])

        # Translate mean and std to 3D tensor
        self.img_mean = np.array(self.img_mean, dtype=np.float32)[:, None, None]
        self.img_std = np.array(self.img_std, dtype=np.float32)[:, None, None]
        
        return TransitionCallbackReturn.SUCCESS
    
    def on_activate(self, state: LifecycleState) -> TransitionCallbackReturn:
        self.get_logger().info(f"[{self.get_name()}] Activating...")

        return TransitionCallbackReturn.SUCCESS
    
    def on_deactivate(self, state: LifecycleState) -> TransitionCallbackReturn:
        self.get_logger().info(f"[{self.get_name()}] Deactivating...")
        return TransitionCallbackReturn.SUCCESS
    
    def on_cleanup(self, state: LifecycleState) -> TransitionCallbackReturn:
        self.get_logger().info(f"[{self.get_name()}] Cleaning up...")
        return TransitionCallbackReturn.SUCCESS
    

    def on_shutdown(self, state: LifecycleState) -> TransitionCallbackReturn:
        self.get_logger().info(f"[{self.get_name()}] Shutting down...")
        return TransitionCallbackReturn.SUCCESS

def main():
    rclpy.init()
    node = Dinov3Node()
    node.trigger_configure()
    node.trigger_activate()

    try:
        rclpy.spin(node)
    except KeyboardInterrupt:
        pass


if __name__ == '__main__':
    main()
